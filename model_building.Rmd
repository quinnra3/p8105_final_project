---
title: "Regression Models"
output:
  html_document:
    toc : true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(readr)
library(dplyr)
library(glmnet)
library(modelr)

knitr::opts_chunk$set(
 echo = TRUE,
 warning = FALSE,
 message = FALSE, 
 fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{r datasets setup, include=FALSE}
dsny_df <- read_csv("data/DSNY_Monthly_Tonnage_Data_20231108.csv") 

dsny_df = 
  dsny_df |> 
  janitor::clean_names() |> 
  separate(month, c("year", "month"), sep = " / ") |> 
  filter(year == "2023") |> 
  select(-communitydistrict, -resorganicstons, -schoolorganictons, -leavesorganictons, -xmastreetons)


rodent_inspec_df <- read_csv("data/Rodent Inspection Data - 2023.csv")

rodent_inspec_df = 
  rodent_inspec_df |> 
  janitor::clean_names() |> 
  select(-job_id, -job_ticket_or_work_order_id, -job_progress, -bbl, -house_number, -street_name, -block, -lot, -approved_date, -location, -community_board, -council_district, -census_tract, -bin, -nta)

rodent_tidy = 
  rodent_inspec_df |>
  mutate(inspection_date = parse_date_time(inspection_date, orders = "mdy HM"),
         day = day(inspection_date), 
         month = sprintf("%02d", month(inspection_date)), 
         year = year(inspection_date),  
         hour = hour(inspection_date),  
         minute = minute(inspection_date)) |> 
  select(-day, -hour, -minute, -boro_code)
  

total_rat_df = merge(dsny_df, rodent_inspec_df)

rat_merge_df = merge(dsny_df, rodent_tidy)
```

--------------------------------------------------------------------------------

## Regression Models: trash pickup in NYC (`refusetonscollected`)

--------------------------------------------------------------------------------

We hypothesize that trash pickup in NYC is a predictor of rodent sighitngs in NYC. To test this hypothesis, we are going to use three different models to predict rodent sightings based on trash pickup in NYC, by longitude and latitude:

* fit1_long = lm(longitude ~ refusetonscollected, data = rat_merge_df)
* fit2_long = lm(longitude ~ papertonscollected, data = rat_merge_df)
* fit3_long = lm(longitude ~ mgptonscollected, data = rat_merge_df)

* fit1_lat = lm(latitude ~ refusetonscollected, data = rat_merge_df)
* fit2_lat = lm(latitude ~ papertonscollected, data = rat_merge_df)
* fit3_lat = lm(latitude ~ mgptonscollected, data = rat_merge_df)

```{r, include=FALSE, eval=FALSE}
long_model =
  lm(longitude ~ refusetonscollected + papertonscollected + mgptonscollected, data = rat_merge_df) |> 
  summary() |> 
  print()

lat_model =
  lm(latitude ~ refusetonscollected + papertonscollected + mgptonscollected, data = rat_merge_df) |> 
  summary() |> 
  print()
```

```{r}
#fits for longitudinal models
fit1_long = lm(longitude ~ refusetonscollected, data = rat_merge_df)
fit2_long = lm(longitude ~ papertonscollected, data = rat_merge_df)
fit3_long = lm(longitude ~ mgptonscollected, data = rat_merge_df)

#fits for latitudinal models
fit1_lat = lm(latitude ~ refusetonscollected, data = rat_merge_df)
fit2_lat = lm(latitude ~ papertonscollected, data = rat_merge_df)
fit3_lat = lm(latitude ~ mgptonscollected, data = rat_merge_df)
```

--------------------------------------------------------------------------------

### Cross Validation

We can now perform a comparison between the six models in terms of cross-validated prediction error. To do so, we create a cross-validation data frame `cv_df`, which includes 2 side-by-side list columns with the testing and training data split pairs. We skip the extra step of converting the testing and training data into tibbles. Next, we use `map` function to each regression model to the training data. Lastly, we compute the root mean squared errors (RMSEs) for each model by applying the `map2_dbl` function to the testing data. 

```{r}
cv_df = 
  crossv_mc(rat_merge_df, 100)

cv_df = cv_df |> 
  mutate(
    mod1 = map(.x = train, ~lm(longitude ~ refusetonscollected, data = .x)), 
    mod2 = map(.x = train, ~lm(longitude ~ papertonscollected, data = .x)), 
    mod3 = map(.x = train, ~lm(longitude ~ mgptonscollected, data = .x)), 
    mod4 = map(.x = train, ~lm(latitude ~ refusetonscollected, data = .x)),
    mod5 = map(.x = train, ~lm(latitude ~ papertonscollected, data = .x)),
    mod6 = map(.x = train, ~lm(latitude ~ mgptonscollected, data = .x))) |> 
  mutate(
    rmse_mod1 = map2_dbl(.x = mod1, .y = test, ~rmse(model = .x, data = .y)), 
    rmse_mod2 = map2_dbl(.x = mod2, .y = test, ~rmse(model = .x, data = .y)), 
    rmse_mod3 = map2_dbl(.x = mod3, .y = test, ~rmse(model = .x, data = .y)),
    rmse_mod4 = map2_dbl(.x = mod4, .y = test, ~rmse(model = .x, data = .y)),
    rmse_mod5 = map2_dbl(.x = mod5, .y = test, ~rmse(model = .x, data = .y)))

cv_df |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(), 
    names_to = "model", 
    values_to = "rmse", 
    names_prefix = "rmse_") |> 
  ggplot(aes(x = model, y = rmse, color = c("#FFA500"))) +
  geom_boxplot(color = c("#FFA500")) + 
  labs(
    title = "Root Mean Squared Errors Distributions for Trash in NYC", 
    x = "Fitted Model", 
    y = "RMSE")  + 
  theme(axis.line = element_line(color = "grey"), 
        panel.background = element_blank(), 
        legend.position = "none", 
        panel.grid.major = element_line(color = "light grey", linetype = "dashed"),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  scale_x_discrete(labels = c("mod1" = "longitude, refusetonscollected", 
                              "mod2" = "longitude, papertonscollected", 
                              "mod3" = "longitude, mgptonscollected",
                              "mod4" = "latitude, refusetonscollected",
                              "mod5" = "latitude, papertonscollected",
                              "mod6" = "latitude, mgptonscollected"))
```

```{r}
summary(fit1_long) |> 
  broom::tidy() |> 
  filter(term == "refusetonscollected") |> 
  mutate(
    lower_ci = exp(estimate - 1.96*std.error),
    upper_ci = exp(estimate + 1.96*std.error)
  ) |> 
  select(term, estimate, lower_ci, upper_ci, p.value) |> 
  knitr::kable(digits = 3, 
               col.names = c("Term", "Estimate", "Lower CI", "Upper CI", "P-value"))
```

We can conclude based on the distributions above that the model with longitude, paper tons collected, is able to generate better predictions than the other models with environmental factors. The p-value for this model is 0, so we can conclude that this model is a predictor for rat sightings in NYC.


